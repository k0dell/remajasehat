<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remaja Cerdas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdf2f8; /* Light pink background */
        }
        .tab-active {
            border-bottom-color: #ec4899; /* Pink-500 */
            color: #ec4899;
            font-weight: 600;
        }
        .tab {
            border-bottom-color: transparent;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="loading-overlay">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-pink-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-pink-600 font-semibold">Memuat data...</p>
        </div>
    </div>

    <div id="app" class="min-h-screen max-w-2xl mx-auto p-4 md:p-6">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-pink-600">Remaja Cerdas</h1>
            <p class="text-gray-500 mt-1">Panduan Cerdas untuk Kesehatan & Kesejahteraanmu</p>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="flex -mb-px space-x-4 sm:space-x-6" aria-label="Tabs">
                <button onclick="changeTab('tracker')" id="tab-tracker" class="tab tab-active group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm">
                    <i data-lucide="calendar-days" class="mr-2 h-5 w-5"></i>
                    Pelacak Siklus
                </button>
                 <button onclick="changeTab('pregnancy')" id="tab-pregnancy" class="tab group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-pink-600 hover:border-gray-300">
                    <i data-lucide="baby" class="mr-2 h-5 w-5"></i>
                    Cek Kehamilan
                </button>
                <button onclick="changeTab('tips')" id="tab-tips" class="tab group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-pink-600 hover:border-gray-300">
                    <i data-lucide="heart-pulse" class="mr-2 h-5 w-5"></i>
                    Tips Sehat
                </button>
            </nav>
        </div>

        <main>
            <div id="content-tracker" class="fade-in space-y-6">
                <!-- Reminder Section -->
                <div id="reminder-section"></div>

                <!-- History and Calculation Section -->
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="font-bold text-xl text-gray-700 mb-1">Riwayat Menstruasimu</h2>
                    <p id="tracker-instruction-text" class="text-sm text-gray-500 mb-4">Memuat instruksi...</p>
                    
                    <div class="flex items-center gap-2 mb-4">
                        <input type="date" id="new-period-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 transition">
                        <button onclick="addPeriodDate()" class="bg-pink-500 text-white font-bold p-3 rounded-lg hover:bg-pink-600 transition-colors duration-300">
                            <i data-lucide="plus" class="h-6 w-6"></i>
                        </button>
                    </div>

                    <div id="period-history-list" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                        <!-- History items will be injected here -->
                    </div>
                </div>

                <!-- Analysis and Prediction Section -->
                <div id="analysis-section" class="bg-white p-6 rounded-2xl shadow-sm">
                     <!-- Analysis and predictions will be shown here -->
                </div>
            </div>
            
            <div id="content-pregnancy" class="hidden fade-in">
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="font-bold text-xl text-gray-700 mb-1">Kalkulator Kemungkinan Kehamilan</h2>
                    <p class="text-sm text-gray-500 mb-6">Cek apakah kamu mengalami keterlambatan menstruasi. Data akan diambil dari riwayat siklusmu.</p>
                    <button onclick="checkPregnancy()" class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-600 transition-colors duration-300 mt-4 flex items-center justify-center">
                        <i data-lucide="search" class="mr-2 h-5 w-5"></i> Cek Status Keterlambatan
                    </button>
                    <div id="pregnancy-result" class="mt-6 hidden"></div>
                </div>
            </div>

            <div id="content-tips" class="hidden fade-in space-y-6">
                 <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="font-bold text-xl text-gray-700 mb-4 flex items-center"><i data-lucide="sparkles" class="h-6 w-6 mr-2 text-pink-500"></i>Tips Seputar Menstruasi</h2>
                    <ul class="list-disc list-inside space-y-2 text-gray-600">
                        <li><strong>Atasi Nyeri Haid:</strong> Kompres perut bagian bawah dengan air hangat, lakukan olahraga ringan seperti jalan santai, atau minum teh herbal (chamomile atau jahe) untuk meredakan kram.</li>
                        <li><strong>Pilih Pembalut yang Tepat:</strong> Ganti pembalut setiap 4-6 jam untuk menjaga kebersihan dan mencegah iritasi. Pilih pembalut yang sesuai dengan derasnya aliran darahmu.</li>
                        <li><strong>Jaga Mood (PMS):</strong> Perubahan hormon bisa mempengaruhi mood. Coba konsumsi cokelat hitam, cukup tidur, dan lakukan aktivitas yang kamu sukai untuk merasa lebih baik.</li>
                    </ul>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="font-bold text-xl text-gray-700 mb-4 flex items-center"><i data-lucide="carrot" class="h-6 w-6 mr-2 text-orange-500"></i>Tips Gaya Hidup Sehat</h2>
                    <ul class="list-disc list-inside space-y-2 text-gray-600">
                        <li><strong>Minum Air Cukup:</strong> Pastikan kamu minum setidaknya 8 gelas air sehari. Ini membantu mengurangi kembung dan membuat tubuh tetap terhidrasi.</li>
                        <li><strong>Makan Makanan Bergizi:</strong> Perbanyak makan sayur, buah, dan makanan kaya zat besi (seperti bayam dan daging merah) untuk menggantikan darah yang hilang saat menstruasi.</li>
                        <li><strong>Istirahat yang Cukup:</strong> Tidur 7-9 jam setiap malam sangat penting untuk energi dan keseimbangan hormonmu.</li>
                    </ul>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="font-bold text-xl text-gray-700 mb-4 flex items-center"><i data-lucide="shield-check" class="h-6 w-6 mr-2 text-green-500"></i>Jaga Kebersihan Diri</h2>
                    <ul class="list-disc list-inside space-y-2 text-gray-600">
                        <li><strong>Area Kewanitaan:</strong> Cukup bersihkan dengan air bersih dari arah depan ke belakang. Hindari sabun wangi yang bisa menyebabkan iritasi.</li>
                        <li><strong>Mandi Teratur:</strong> Mandi dua kali sehari akan membuatmu merasa segar dan bersih, terutama saat sedang menstruasi.</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        let auth, db, userId;
        const state = { 
            activeTab: 'tracker',
            periodHistory: [], // Array of "YYYY-MM-DD" strings
            averageCycle: 0,
        };

        // --- FIREBASE CONFIG ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- UI HELPER FUNCTIONS ---
        window.changeTab = (tabName) => {
            if (state.activeTab === tabName) return;
            state.activeTab = tabName;
            ['tracker', 'pregnancy', 'tips'].forEach(key => {
                document.getElementById(`tab-${key}`).classList.toggle('tab-active', key === tabName);
                document.getElementById(`tab-${key}`).classList.toggle('text-gray-500', key !== tabName);
                document.getElementById(`content-${key}`).classList.toggle('hidden', key !== tabName);
            });
        };
        
        const formatDate = (date) => date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        const parseDateString = (dateString) => {
            if (!dateString) return null;
            const parts = dateString.split('-');
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        };
        
        // --- CORE APPLICATION LOGIC ---
        
        const processHistory = () => {
            // Sort history from newest to oldest
            state.periodHistory.sort((a, b) => new Date(b) - new Date(a));
            
            // Calculate average cycle length
            if (state.periodHistory.length < 2) {
                state.averageCycle = 0;
            } else {
                let diffs = [];
                for (let i = 0; i < state.periodHistory.length - 1; i++) {
                    const dateA = parseDateString(state.periodHistory[i]);
                    const dateB = parseDateString(state.periodHistory[i+1]);
                    const diffTime = Math.abs(dateA - dateB);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    diffs.push(diffDays);
                }
                const total = diffs.reduce((acc, c) => acc + c, 0);
                state.averageCycle = Math.round(total / diffs.length);
            }
            
            // Update UI
            updateTrackerInstructions();
            renderHistoryList();
            renderAnalysisAndPrediction();
            displayReminder();
        };

        const updateTrackerInstructions = () => {
            const instructionP = document.getElementById('tracker-instruction-text');
            if (state.periodHistory.length === 0) {
              instructionP.innerHTML = 'Yuk mulai! Masukkan tanggal hari pertama haid <b>bulan lalu</b> dan <b>bulan ini</b> untuk menghitung siklus pertamamu.';
            } else if (state.periodHistory.length === 1) {
              instructionP.innerHTML = 'Bagus! Sekarang tambahkan tanggal haid <b>bulan sebelumnya</b> agar kami bisa menghitung rata-rata siklusmu.';
            } else {
              instructionP.innerHTML = 'Terus tambahkan tanggal mulai haidmu setiap bulan. Kami akan hitung rata-rata siklusmu secara otomatis!';
            }
        };

        const renderHistoryList = () => {
            const listEl = document.getElementById('period-history-list');
            if (state.periodHistory.length === 0) {
                listEl.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">Belum ada riwayat.</p>`;
                return;
            }
            listEl.innerHTML = state.periodHistory.map(dateStr => {
                const date = parseDateString(dateStr);
                return `
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded-md">
                    <span class="text-sm font-medium">${formatDate(date)}</span>
                    <button onclick="removePeriodDate('${dateStr}')" class="text-red-500 hover:text-red-700 p-1">
                        <i data-lucide="trash-2" class="h-4 w-4"></i>
                    </button>
                </div>`;
            }).join('');
            lucide.createIcons();
        };
        
        const renderAnalysisAndPrediction = () => {
            const analysisEl = document.getElementById('analysis-section');
            const lastPeriodDateStr = state.periodHistory[0];

            if (state.periodHistory.length < 1) {
                analysisEl.innerHTML = `<p class="text-center text-gray-500">Hasil analisis dan prediksimu akan muncul di sini.</p>`;
                return;
            }

            let analysisHtml = '';
            if (state.averageCycle > 0) {
                 analysisHtml = `<div class="text-center p-4 bg-pink-50 rounded-lg mb-4">
                    <p class="text-sm text-pink-800">Rata-rata siklusmu adalah</p>
                    <p class="text-3xl font-bold text-pink-600">${state.averageCycle} hari</p>
                    <p class="text-xs text-pink-700">(dihitung dari ${state.periodHistory.length - 1} siklus terakhir)</p>
                 </div>`;
            } else {
                 analysisHtml = `<div class="text-center p-4 bg-blue-50 rounded-lg mb-4">
                    <p class="text-blue-800 font-semibold">Butuh Satu Data Lagi!</p>
                    <p class="text-sm text-blue-700">Tambahkan setidaknya satu riwayat haid lagi untuk menghitung rata-rata siklusmu.</p>
                 </div>`;
            }

            let predictionHtml = '';
            if (lastPeriodDateStr && state.averageCycle > 0) {
                const lastPeriodDate = parseDateString(lastPeriodDateStr);
                const nextPeriodDate = new Date(lastPeriodDate);
                nextPeriodDate.setDate(lastPeriodDate.getDate() + state.averageCycle);

                const ovulationDate = new Date(nextPeriodDate);
                ovulationDate.setDate(nextPeriodDate.getDate() - 14);

                const fertileStart = new Date(ovulationDate);
                fertileStart.setDate(ovulationDate.getDate() - 5);
                const fertileEnd = new Date(ovulationDate);
                fertileEnd.setDate(ovulationDate.getDate() + 1);

                predictionHtml = `
                    <h3 class="font-bold text-lg text-pink-600 mb-4">Hasil Prediksimu:</h3>
                    <div class="space-y-4">
                        <div class="flex items-start"><i data-lucide="calendar-check" class="h-6 w-6 text-rose-500 mr-4 mt-1 flex-shrink-0"></i><div><p class="font-semibold text-gray-700">Prediksi Haid Berikutnya</p><p class="text-2xl font-bold text-rose-500">${formatDate(nextPeriodDate)}</p></div></div>
                        <div class="flex items-start"><i data-lucide="flower-2" class="h-6 w-6 text-green-500 mr-4 mt-1 flex-shrink-0"></i><div><p class="font-semibold text-gray-700">Perkiraan Masa Subur</p><p class="text-lg font-medium text-green-600">${formatDate(fertileStart)} - ${formatDate(fertileEnd)}</p></div></div>
                    </div>`;
            }
            analysisEl.innerHTML = analysisHtml + predictionHtml;
            lucide.createIcons();
        };

        const displayReminder = () => {
            const reminderDiv = document.getElementById('reminder-section');
            const lastPeriodDateStr = state.periodHistory[0];
            const cycleLength = state.averageCycle;

            if (!lastPeriodDateStr || !cycleLength) {
                reminderDiv.innerHTML = ``;
                return;
            }

            const lastPeriodDate = parseDateString(lastPeriodDateStr);
            const nextPeriodDate = new Date(lastPeriodDate);
            nextPeriodDate.setDate(lastPeriodDate.getDate() + cycleLength);
            const today = new Date(); today.setHours(0, 0, 0, 0);
            
            const daysUntil = Math.ceil((nextPeriodDate - today) / (1000 * 3600 * 24));
            
            let message = '';
            if (daysUntil > 1) message = `<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg"><p class="font-bold">Pengingat</p><p>Haid berikutnya diperkirakan datang dalam <strong>${daysUntil} hari</strong> lagi.</p></div>`;
            else if (daysUntil === 1) message = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg"><p class="font-bold">Pengingat</p><p>Haid berikutnya diperkirakan datang <strong>besok</strong>. Siap-siap ya!</p></div>`;
            else if (daysUntil === 0) message = `<div class="bg-pink-100 border-l-4 border-pink-500 text-pink-700 p-4 rounded-lg"><p class="font-bold">Hari H!</p><p>Menurut jadwal, hari ini kamu akan menstruasi.</p></div>`;
            else message = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg"><p class="font-bold">Kamu Terlambat</p><p>Kamu telah terlambat haid sekitar <strong>${-daysUntil} hari</strong>.</p></div>`;
            reminderDiv.innerHTML = message;
        };

        window.addPeriodDate = async () => {
            const newDate = document.getElementById('new-period-date').value;
            if (!newDate) { alert('Pilih tanggal terlebih dahulu ya.'); return; }
            if (state.periodHistory.includes(newDate)) { alert('Tanggal ini sudah ada dalam riwayat.'); return; }
            
            state.periodHistory.push(newDate);
            document.getElementById('new-period-date').value = '';
            await saveData();
        };
        
        window.removePeriodDate = async (dateToRemove) => {
            state.periodHistory = state.periodHistory.filter(date => date !== dateToRemove);
            await saveData();
        };

        const saveData = async () => {
            if (!userId) return;
            processHistory(); // Update UI immediately
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/period_tracker/data`);
                await setDoc(userDocRef, { periodHistory: state.periodHistory });
            } catch (error) {
                console.error("Error saving data: ", error);
                alert("Gagal menyimpan data ke cloud. Perubahanmu mungkin tidak akan tersimpan.");
            }
        };

        window.checkPregnancy = () => {
            const resultDiv = document.getElementById('pregnancy-result');
            const lastPeriodDateStr = state.periodHistory[0];
            const cycleLength = state.averageCycle;

            if (!lastPeriodDateStr || !cycleLength) {
                resultDiv.innerHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg"><p class="font-bold">Data Tidak Lengkap</p><p>Catat setidaknya 2 riwayat haid di tab 'Pelacak Siklus' terlebih dahulu.</p></div>`;
                resultDiv.classList.remove('hidden'); return;
            }

            const lastPeriodDate = parseDateString(lastPeriodDateStr);
            const nextPeriodDate = new Date(lastPeriodDate);
            nextPeriodDate.setDate(lastPeriodDate.getDate() + cycleLength);
            const today = new Date(); today.setHours(0,0,0,0);
            const daysLate = Math.ceil((today - nextPeriodDate) / (1000 * 3600 * 24));

            let resultMessage = '';
            if (daysLate > 0) resultMessage = `<div class="bg-pink-100 border-l-4 border-pink-500 text-pink-700 p-4 rounded-lg"><p class="font-bold">Kamu Terlambat Haid!</p><p>Berdasarkan perhitungan, kamu telah terlambat sekitar <strong>${daysLate} hari</strong>. Ini bisa menjadi tanda awal kehamilan.</p><p class="mt-2 text-sm"><strong>Penting:</strong> Ini bukan diagnosis medis. Untuk hasil yang akurat, segera lakukan tes kehamilan dan konsultasikan dengan dokter.</p></div>`;
            else if (daysLate === 0) resultMessage = `<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg"><p class="font-bold">Hari Ini Jadwal Haidmu</p><p>Menurut prediksi, hari ini adalah jadwal menstruasimu.</p></div>`;
            else resultMessage = `<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg"><p class="font-bold">Belum Ada Keterlambatan</p><p>Jadwal haid berikutnya adalah sekitar tanggal ${formatDate(nextPeriodDate)}.</p></div>`;
            resultDiv.innerHTML = resultMessage;
            resultDiv.classList.remove('hidden');
        };

        // --- INITIALIZATION ---
        const initializeAppAndAuth = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) { userId = user.uid; await loadUserData(); } 
                    else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                            else await signInAnonymously(auth);
                        } catch (error) { console.error("Sign-in failed:", error); }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loading-overlay').style.display = 'none';
            }
        };

        const loadUserData = async () => {
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/period_tracker/data`);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    state.periodHistory = docSnap.data().periodHistory || [];
                    processHistory();
                } else {
                   processHistory(); // To render initial empty state
                }
            } catch (error) {
                console.error("Error loading data:", error);
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        };

        window.onload = () => {
            lucide.createIcons();
            changeTab('tracker');
            initializeAppAndAuth();
        };
    </script>
</body>
</html>

